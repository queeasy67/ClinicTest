<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QueEasy Pro | Bilingual Command</title>
    
    <!-- Core Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com" rel="stylesheet">
    <script src="https://unpkg.com"></script>
    <script src="https://unpkg.com"></script>
    <script src="https://unpkg.com"></script>
    <script src="https://www.gstatic.com"></script>
    <script src="https://www.gstatic.com"></script>
    <link href="https://cdn.jsdelivr.net" rel="stylesheet">

    <style>
        :root { --accent: #3b82f6; --surface: #ffffff; --bg: #f8fafc; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: #0f172a; height: 100vh; overflow: hidden; margin: 0; }
        .bento-card { background: var(--surface); border-radius: 2.5rem; box-shadow: 0 20px 40px -12px rgba(0, 0, 0, 0.05); border: 1px solid rgba(226, 232, 240, 0.8); }
        .tv-screen { background: radial-gradient(circle at top right, #1e293b, #020617); color: #f8fafc; height: 100vh; width: 100vw; }
        .cyber-panel { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.05); border-radius: 2rem; }
        .hero-glow { text-shadow: 0 0 30px rgba(59, 130, 246, 0.5); animation: pulse-glow 2s infinite alternate; }
        @keyframes pulse-glow { from { transform: scale(1); } to { transform: scale(1.02); } }
        .ticker-bar { background: linear-gradient(90deg, #1e40af, #3b82f6); height: 60px; display: flex; align-items: center; position: fixed; bottom: 60px; width: 100%; overflow: hidden; }
        .marquee-content { white-space: nowrap; display: inline-block; animation: marquee 30s linear infinite; font-weight: 800; font-size: 1.25rem; color: white; }
        @keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        .mono-num { font-family: 'JetBrains Mono', monospace; }
        .glass-nav { background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(12px); border-top: 1px solid rgba(255,255,255,0.1); position: fixed; bottom: 0; width: 100%; height: 60px; display: flex; justify-content: center; align-items: center; gap: 40px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // Step 1: Firebase Configuration
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyDZ6K02v3Ovwo7xLqL4x33sIQNzv3ydXL8",
            authDomain: "queueasy-ea33b.firebaseapp.com",
            projectId: "queueasy-ea33b",
            storageBucket: "queueasy-ea33b.firebasestorage.app",
            messagingSenderId: "507246685294",
            appId: "1:507246685294:web:958210e662e481e021ca7f"
        };

        // Step 2: Initialize Firebase
        if (!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG);
        const db = firebase.firestore();

        // Step 3: Main Application Component
        const App = () => {
            const [view, setView] = React.useState('tv');
            const [lang, setLang] = React.useState('en');
            const [queue, setQueue] = React.useState([]);
            const [config, setConfig] = React.useState({
                header: 'QueEasy Clinic',
                tickerText: 'Welcome to QueEasy. Your health is our priority.',
                templateEn: "Number {number}, please proceed to {room}",
                templateMs: "Nombor {number}, sila ke {room}"
            });
            const [showSettings, setShowSettings] = React.useState(false);
            const [audioUnlocked, setAudioUnlocked] = React.useState(false);
            const lastCallRef = React.useRef(0);
            const chime = new Audio('https://assets.mixkit.co');

            // Data Sync
            React.useEffect(() => {
                const unsubQ = db.collection("queue").orderBy("time", "desc").limit(20)
                    .onSnapshot(snap => setQueue(snap.docs.map(d => ({id: d.id, ...d.data()}))));
                const unsubC = db.collection("settings").doc("config")
                    .onSnapshot(doc => doc.exists && setConfig(prev => ({...prev, ...doc.data()})));
                return () => { unsubQ(); unsubC(); };
            }, []);

            // Bilingual Voice Engine
            const playVoice = (num, room) => {
                if(!audioUnlocked) return;
                const parse = (t, n, r) => t.replace('{number}', n).replace('{room}', r.replace('Room ', ''));
                
                chime.play().then(() => {
                    const en = new SpeechSynthesisUtterance(parse(config.templateEn, num, room));
                    en.lang = 'en-US';
                    en.onend = () => {
                        const ms = new SpeechSynthesisUtterance(parse(config.templateMs, num, room));
                        ms.lang = 'ms-MY';
                        window.speechSynthesis.speak(ms);
                    };
                    window.speechSynthesis.speak(en);
                });
            };

            const currentCaller = queue.find(p => p.status === 'calling');
            React.useEffect(() => {
                if(view === 'tv' && currentCaller && currentCaller.callTrigger > lastCallRef.current) {
                    lastCallRef.current = currentCaller.callTrigger;
                    playVoice(currentCaller.num, currentCaller.loc);
                }
            }, [currentCaller, view]);

            // --- VIEW RENDERING ---
            return (
                <div className="h-screen w-screen relative">
                    {view === 'tv' ? (
                        <div className="h-full tv-screen flex flex-col">
                            {!audioUnlocked && (
                                <div className="absolute inset-0 z-50 bg-black/90 flex items-center justify-center">
                                    <button onClick={() => {setAudioUnlocked(true); chime.play();}} className="bg-blue-600 text-white px-10 py-5 rounded-full font-black text-xl animate-bounce">START SYSTEM</button>
                                </div>
                            )}
                            <div className="flex justify-between items-center px-12 py-8 cyber-panel rounded-none">
                                <h1 className="text-3xl font-black">{config.header}</h1>
                                <div className="text-4xl font-black mono-num">{new Date().toLocaleTimeString()}</div>
                            </div>
                            <div className="flex-1 flex flex-col items-center justify-center">
                                {currentCaller ? (
                                    <div>
                                        <p className="text-blue-400 font-black tracking-widest uppercase mb-4">{lang === 'en' ? 'Now Calling' : 'Sedang Dipanggil'}</p>
                                        <h1 className="text-[12rem] font-black hero-glow mono-num leading-none">{currentCaller.num}</h1>
                                        <div className="bg-white text-black px-12 py-4 rounded-2xl text-5xl font-black mt-10 inline-block">{currentCaller.loc}</div>
                                    </div>
                                ) : (
                                    <p className="text-4xl font-black opacity-10 uppercase tracking-widest">Standing By</p>
                                )}
                            </div>
                            <div className="ticker-bar"><div className="marquee-content">{config.tickerText}</div></div>
                        </div>
                    ) : (
                        <div className="p-10 text-slate-900">
                            <div className="flex justify-between items-center mb-10">
                                <h1 className="text-4xl font-black">Staff Console</h1>
                                <button onClick={() => setLang(lang === 'en' ? 'ms' : 'en')} className="bg-white border-2 px-6 py-2 rounded-xl font-bold text-blue-600">{lang === 'en' ? 'BM' : 'EN'}</button>
                            </div>
                            {queue.filter(p => p.status !== 'completed').map(p => (
                                <div key={p.id} className="p-6 bg-white border rounded-3xl flex justify-between items-center mb-4">
                                    <span className="text-3xl font-black mono-num">{p.num}</span>
                                    <button 
                                        onClick={() => db.collection("queue").doc(p.id).update({ status: p.status === 'calling' ? 'completed' : 'calling', callTrigger: Date.now(), loc: 'Room 1' })}
                                        className="px-10 py-3 bg-blue-600 text-white rounded-xl font-bold"
                                    >
                                        {p.status === 'calling' ? 'FINISH' : 'CALL'}
                                    </button>
                                </div>
                            ))}
                            <button onClick={() => setShowSettings(true)} className="mt-10 text-slate-400 font-bold uppercase tracking-widest text-xs"><i className="ri-settings-4-fill mr-2"></i> Open Settings</button>
                        </div>
                    )}

                    <div className="glass-nav">
                        <button onClick={() => setView('tv')} className={`font-black text-[10px] tracking-widest ${view === 'tv' ? 'text-blue-400' : 'text-white/40'}`}>TV VIEW</button>
                        <button onClick={() => setView('admin')} className={`font-black text-[10px] tracking-widest ${view === 'admin' ? 'text-blue-400' : 'text-white/40'}`}>ADMIN</button>
                    </div>

                    {showSettings && (
                        <div className="fixed inset-0 z-[100] bg-slate-950/90 backdrop-blur-md flex items-center justify-center p-6">
                            <div className="bg-white rounded-[3rem] p-12 w-full max-w-xl text-slate-800">
                                <h2 className="text-3xl font-black mb-8">Voice Config</h2>
                                <div className="space-y-6">
                                    <input value={config.templateEn} onChange={e => setConfig({...config, templateEn: e.target.value})} className="w-full p-4 bg-slate-50 border rounded-xl" placeholder="English Template" />
                                    <input value={config.templateMs} onChange={e => setConfig({...config, templateMs: e.target.value})} className="w-full p-4 bg-slate-50 border rounded-xl" placeholder="Malay Template" />
                                    <button onClick={async () => { await db.collection("settings").doc("config").set(config); setShowSettings(false); }} className="w-full bg-blue-600 text-white p-5 rounded-2xl font-black">SAVE CHANGES</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Initialize the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>
